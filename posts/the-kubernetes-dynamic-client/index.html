<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The Kubernetes dynamic client | Simple Made Daily</title><meta name=keywords content="go,kubernetes,testing"><meta name=description content="A dive into a hidden tool to build Controllers and Operators"><meta name=author content="Caio Ferreira"><link rel=canonical href=https://caioferreira.dev/posts/the-kubernetes-dynamic-client/><link crossorigin=anonymous href=/assets/css/stylesheet.d53593ac5b971ecf76b17a47ca5e9838cbe9f27c71a39c42e20c4361a252c9c0.css integrity="sha256-1TWTrFuXHs92sXpHyl6YOMvp8nxxo5xC4gxDYaJSycA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://caioferreira.dev/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://caioferreira.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://caioferreira.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://caioferreira.dev/apple-touch-icon.png><link rel=mask-icon href=https://caioferreira.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/atom-one-dark.min.css integrity="sha512-Fcqyubi5qOvl+yCwSJ+r7lli+CO1eHXMaugsZrnxuU4DVpLYWXTVoHy55+mCb4VZpMgy7PBhV7IiymC0yu9tkQ==" crossorigin=anonymous referrerpolicy=no-referrer><meta property="og:title" content="The Kubernetes dynamic client"><meta property="og:description" content="A dive into a hidden tool to build Controllers and Operators"><meta property="og:type" content="article"><meta property="og:url" content="https://caioferreira.dev/posts/the-kubernetes-dynamic-client/"><meta property="og:image" content="https://caioferreira.dev/posts/the-kubernetes-dynamic-client/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-28T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-28T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://caioferreira.dev/posts/the-kubernetes-dynamic-client/cover.png"><meta name=twitter:title content="The Kubernetes dynamic client"><meta name=twitter:description content="A dive into a hidden tool to build Controllers and Operators"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://caioferreira.dev/posts/"},{"@type":"ListItem","position":2,"name":"The Kubernetes dynamic client","item":"https://caioferreira.dev/posts/the-kubernetes-dynamic-client/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The Kubernetes dynamic client","name":"The Kubernetes dynamic client","description":"A dive into a hidden tool to build Controllers and Operators","keywords":["go","kubernetes","testing"],"articleBody":" Introduction Kubernetes won the battle for the cloud-native platform and the characteristic that makes me enjoy the most working with it is its extensibility. By providing an open model through the kube-apiserver, without splitting an internal and external interface, we can interact with the cluster and any other system to integrate both from the same application (Controller) and even use custom resources to describe our unique operations, know as the Operator Pattern.\nAlthough one could use any HTTP Client to interact with the API Server, this is no simple task. There are many resources with different response structures and possible operations if we only consider the core resources on Kubernetes. Hence, Kubernetes itself provides a set of clients for easier integration through the k8s.io/client-go project.\nThe most used client provided by this project is the k8s.io/client-go/kubernets.ClientSet, which is a typed client. What that means is that this interface provides exclusive methods for each resource on Kubernetes (think of Pods, Deployments, Services, everything!) and operation (Create, Get, List, Watch, Update, Patch and Delete). It is obvious why you should, whenever possible, prefer to use this client.\nHowever, there are situations where this can be limiting. It is when k8s.io/client-go/dynamic.Interface, the dynamic client, will enter the game. This client has a twofold purpose:\nFirst, it allows working with custom resources while avoiding strong dependencies. If you want to build some automation or workflow using another Operator as the building block, like ExternalDNS, CertManager, or Prometheus (Operator) usually you would need to add these projects as dependencies to use their Go types and register them on your client instance. This obviously introduces a lot of burdens as you now need to manage their ever-evolving versions and try to keep the version you have installed on the cluster matching the version on your go.mod.\nSecondly, you can work with multiple or unknown resources. When your operator implements a generic logic that can interact with any common Kubernetes resource (from RBAC to Pods) and even custom resources, the dynamic client may be your only solution. A few examples are the garbage collection controller relies heavily on it and if you would want to add support for an arbitrary custom resource on a project like KubeWatch.\nTherefore, letâ€™s dive into this resourceful (pun intended) component of the k8s.io/client-go project and see how we can leverage it.\nBasic operations with the dynamic client The code below assumes to be running inside a Kubernetes cluster.\nMany operations with the dynamic client is similar to the typed client, like creating a new instance can be done by providing the config to its constructor:\nfunc newClient() (dynamic.Interface, error) { config, err := rest.InClusterConfig() if err != nil { return nil, err } dynClient, err := dynamic.NewForConfig(config) if err != nil { return nil, err } return dynClient, nil } Since the dynamic client has no knowledge about the resource you want to consume, it does not provide helper methods like CoreV1().Pod . Instead, you need to first provide a schema.GroupVersionResource, which is a Golang type that provides the necessary information to construct an HTTP request to the cluster API Server.\nFor example, if you want a function to list all MongoDB resources from the MongoDB Community Operator:\nvar monboDBResource = schema.GroupVersionResource{Group: \"mongodbcommunity.mongodb.com\", Version: \"v1\", Resource: \"mongodbcommunity\"} func ListMongoDB(ctx context.Context, client dynamic.Interface, namespace string) ([]unstructured.Unstructured, error) { // GET /apis/mongodbcommunity.mongodb.com/v1/namespaces/{namespace}/mongodbcommunity/ list, err := client.Resource(monboDBResource).Namespace(namespace).List(ctx, metav1.ListOptions{}) if err != nil { return nil, err } return list.Items, nil } Note that if you are dealing with a namespaced resource then .Namespace(namespace) is obligatory, even if you will use an empty string to list on all namespaces.\nIn this snippet, we can see the main companion of the dynamic client: unstructured.Unstructured. This is a special type that encapsulates an arbitrary JSON while also complying with standard Kubernetes interfaces like runtime.Object , but most importantly it provides a set of helpers on the unstructured package to manipulate this data.\nExpanding our example, if we would scale a MongoDB by an proportion we could do so like:\n// ScaleMongoDB changes the number of members by the given proportion, // which should be 0 =\u003c proportion \u003c 1. func ScaleMongoDB(ctx context.Context, client dynamic.Interface, name string, namespace string, proportion uint) error { if proportion \u003e 1 { return fmt.Errorf(\"proportion should be between 0 =\u003c proportion \u003c 1\") } mongoDBClient := client.Resource(monboDBResource).Namespace(namespace) mdb, err := mongoDBClient.Get(ctx, name, metav1.GetOptions{}) if err != nil { return err } members, found, err := unstructured.NestedInt64(mdb.UnstructuredContent(), \"spec\", \"members\") if err != nil { return err } if !found { return fmt.Errorf(\"members field not found on MongoDB spec\") } scaled := int(members) * (1 + int(proportion)) patch := []interface{}{ map[string]interface{}{ \"op\": \"replace\", \"path\": \"/spec/members\", \"value\": scaled, }, } payload, err := json.Marshal(patch) if err != nil { return err } _, err = mongoDBClient.Patch(ctx, name, types.JSONPatchType, payload, metav1.PatchOptions{}) if err != nil { return err } return nil } Here we leverage unstructured.NestedInt64 to access only the field that we are interested in, keeping our coupling to the MongoDB CRD to a minimum while also being able to manipulate the resource data with type safety.\nThe unstructured package has lots of helpers like this, not only for reading but also for writing to any field on the resource.\nPerforming all the usual operations on Kubernetes (get, list, watch, create, patch, and delete) follow the same approach: provide the scheme.GroupVersionResource and handle the unstructured.Unstructured result.\nController with a dynamic client More advanced but frequent use of a Kubernetes client is to build a controller that reacts to changes on the actual cluster state to bring it to the desired state.\nUsually, we leverage an Informer, a component provided by k8s.io/client-go, that runs a handler when changes are detected, created from a typed client. Luckily the dynamic package also provides an Informer component that we can use.\nFor example, if we want to capture when a MongoDB is deleted to clean the associated PersistentVolumeClaims:\npackage main import ( \"fmt\" utilruntime \"k8s.io/apimachinery/pkg/util/runtime\" \"k8s.io/apimachinery/pkg/util/wait\" \"k8s.io/client-go/dynamic\" \"k8s.io/client-go/dynamic/dynamicinformer\" \"k8s.io/client-go/tools/cache\" \"k8s.io/client-go/util/workqueue\" \"time\" ) const maxRetries = 3 var monboDBResource = schema.GroupVersionResource{Group: \"mongodbcommunity.mongodb.com\", Version: \"v1\", Resource: \"mongodbcommunity\"} type MongoDBController struct { informer cache.SharedIndexInformer stopper chan struct{} queue workqueue.RateLimitingInterface } func NewMongoDBController(client dynamic.Interface) (*MongoDBController, error) { dynInformer := dynamicinformer.NewDynamicSharedInformerFactory(client, 0) informer := dynInformer.ForResource(monboDBResource).Informer() stopper := make(chan struct{}) queue := workqueue.NewRateLimitingQueue(workqueue.DefaultControllerRateLimiter()) informer.AddEventHandler(cache.ResourceEventHandlerFuncs{ DeleteFunc: func(obj interface{}) { key, err := cache.DeletionHandlingMetaNamespaceKeyFunc(obj) if err == nil { queue.Add(key) } }, }) return \u0026MongoDBController{ informer: informer, queue: queue, stopper: stopper, }, nil } func (m *MongoDBController) Stop() { close(m.stopper) } func (m *MongoDBController) Run() { defer utilruntime.HandleCrash() defer m.queue.ShutDown() go m.informer.Run(m.stopper) // wait for the caches to synchronize before starting the worker if !cache.WaitForCacheSync(m.stopper, m.informer.HasSynced) { utilruntime.HandleError(fmt.Errorf(\"timed out waiting for caches to sync\")) return } // runWorker will loop until some problem happens. The wait.Until will then restart the worker after one second wait.Until(m.runWorker, time.Second, m.stopper) } func (m *MongoDBController) runWorker() { for { key, quit := m.queue.Get() if quit { return } err := m.processItem(key.(string)) if err == nil { m.queue.Forget(key) } else if m.queue.NumRequeues(key) \u003c maxRetries { m.queue.AddRateLimited(key) } else { m.queue.Forget(key) utilruntime.HandleError(err) } m.queue.Done(key) } } func (m *MongoDBController) processItem(mongodb string) error { // Clean up PVCs return nil } Most of this code is standard, like the work queue, informer event handlers, and item processing, of a controller using the typed client.\nHence, leveraging the decoupling provided by the dynamic client really comes with a low overhead in terms of complexity.\nTesting with the dynamic client If we were to scale the use of the dynamic client it is paramount that it is as easy to test as the typed client.\nAs in the controller case, the dynamic package provides an equivalent fake client that allows for stubbing objects and asserting actions performed using it.\npackage main import ( \"context\" \"k8s.io/apimachinery/pkg/runtime\" dynamicfake \"k8s.io/client-go/dynamic/fake\" ) func TestDynamicClient(t *testing.T) { // Setup an Object as mock on the client // Write it like its YAML manifest mdb := \u0026unstructured.Unstructured{} mdb.SetUnstructuredContent(map[string]interface{}{ \"apiVersion\": \"mongodbcommunity.mongodb.com/v1\", \"kind\": \"MongoDBCommunity\", \"metadata\": map[string]interface{} { \"name\": \"mongodb-test\", \"namespace\": \"default\", }, \"spec\": map[string]interface{}{ \"members\": 3, }, }) dynamicClient := dynamicfake.NewSimpleDynamicClient(runtime.NewScheme(), mdb) // Run any logic that depend on the dynamic client NotifyMongoDBs(context.Background(), dynamicClient) AssertActions(t, dynamicClient.Actions(), []ExpectedAction{ { Verb: \"list\", Namespace: \"default\", Resource: \"mongodbcommunity\", }, }) } Using the unestructured.Unestructured type we can create stub Kubernetes objects using the same syntax as in YAML, but with maps.\nAfter performing the tested logic we can use dynamicClient.Actions() to see all operations that were performed by our code. However, manually asserting these actions on every test often lead to unreadable code and brittle assertions.\nHence, I often use a special assertion function AssertActions that verify if every expected action can be found in the performed actions. An important note is that this function does not perform an exact list match, i.e. if a delete operation was performed using the client the test would not break, the only condition for the AssertActions to fail is if the list operation provided on the expected list isnâ€™t found. One could change the asserting function or make a sibling function that validates only if the expected actions were performed.\nAlthough the current implementation is verbose, this function has the benefit of working both with the dynamic and the typed client.\ntype ExpectedAction struct { Verb string Name string Namespace string Resource string // Patch action PatchType types.PatchType PatchPayload []map[string]interface{} } func AssertActions(t *testing.T, got []kubetesting.Action, expected []ExpectedAction) { if len(expected) \u003e len(got) { t.Fatalf(\"executed actions too short, expected %d, got %d\", len(expected), len(got)) return } for i, expectedAction := range expected { if !AssertExpectedAction(got, expectedAction) { t.Fatalf(\"action %d does not match any of the got actions\", i) } } } func AssertExpectedAction(got []kubetesting.Action, expectedAction ExpectedAction) bool { for _, gotAction := range got { switch expectedAction.Verb { case \"get\": getAction, ok := gotAction.(kubetesting.GetAction) if !ok { continue } if getAction.GetName() != expectedAction.Name { continue } if !validateNamespaceAndResource(getAction, expectedAction) { continue } return true case \"list\": listAction, ok := gotAction.(kubetesting.ListAction) if !ok { continue } if !validateNamespaceAndResource(listAction, expectedAction) { continue } return true case \"watch\": watchAction, ok := gotAction.(kubetesting.WatchAction) if !ok { continue } if !validateNamespaceAndResource(watchAction, expectedAction) { continue } return true case \"create\": createAction, ok := gotAction.(kubetesting.CreateAction) if !ok { continue } if !validateNamespaceAndResource(createAction, expectedAction) { continue } return true case \"update\": updateAction, ok := gotAction.(kubetesting.UpdateAction) if !ok { continue } if !validateNamespaceAndResource(updateAction, expectedAction) { continue } return true case \"delete\": deleteAction, ok := gotAction.(kubetesting.DeleteAction) if !ok { continue } if deleteAction.GetName() != expectedAction.Name { continue } if !validateNamespaceAndResource(deleteAction, expectedAction) { continue } return true case \"patch\": patchAction, ok := gotAction.(kubetesting.PatchAction) if !ok { continue } if patchAction.GetName() != expectedAction.Name { continue } if !validateNamespaceAndResource(patchAction, expectedAction) { continue } if patchAction.GetPatchType() != expectedAction.PatchType { continue } patchBytes, err := json.Marshal(expectedAction.PatchPayload) if err != nil { continue } if !bytes.Equal(patchAction.GetPatch(), patchBytes) { continue } return true } } return false } func validateNamespaceAndResource(action kubetesting.Action, expectedAction ExpectedAction) bool { return action.GetNamespace() == expectedAction.Namespace \u0026\u0026 action.GetResource().Resource == expectedAction.Resource } This asserting function allows for more conditions to be added, like verifying list/watch restrictions and create/update bodies.\nConclusion The Kubernetes ecosystem is rich and every now and then we stumble upon this kind of treasure. I strongly recommend reading through the documentation not only of the k8s.io/client-go project but also from the sigs.k8s.io/controller-runtime project and the Kubernetes Reference API documentation.\n","wordCount":"1885","inLanguage":"en","datePublished":"2021-05-28T00:00:00Z","dateModified":"2021-05-28T00:00:00Z","author":{"@type":"Person","name":"Caio Ferreira"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://caioferreira.dev/posts/the-kubernetes-dynamic-client/"},"publisher":{"@type":"Organization","name":"Simple Made Daily","logo":{"@type":"ImageObject","url":"https://caioferreira.dev/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://caioferreira.dev/ accesskey=h title="Simple Made Daily (Alt + H)"><img src=https://caioferreira.dev/logo.png alt aria-label=logo height=28>Simple Made Daily</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://caioferreira.dev/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://caioferreira.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://caioferreira.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>The Kubernetes dynamic client</h1><div class=post-description>A dive into a hidden tool to build Controllers and Operators</div><div class=post-meta><span title='2021-05-28 00:00:00 +0000 UTC'>May 28, 2021</span>&nbsp;Â·&nbsp;9 min&nbsp;Â·&nbsp;Caio Ferreira&nbsp;|&nbsp;<a href=https://github.com/caiorcferreira/caioferreira.dev/tree/main/content/posts/the-kubernetes-dynamic-client/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p><img loading=lazy src=./cover.png alt></p><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Kubernetes won the battle for the cloud-native platform and the characteristic that makes me enjoy the most working with it is its extensibility. By providing an open model through the <code>kube-apiserver</code>, without splitting an internal and external interface, we can interact with the cluster and any other system to integrate both from the same application (Controller) and even use custom resources to describe our unique operations, know as the <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/operator/>Operator Pattern</a>.</p><p>Although one could use any HTTP Client to interact with the API Server, this is no simple task. There are many resources with different response structures and possible operations if we only consider the core resources on Kubernetes. Hence, Kubernetes itself provides a set of clients for easier integration through the <a href=https://github.com/kubernetes/client-go><code>k8s.io/client-go</code> project</a>.</p><p>The most used client provided by this project is the <code>k8s.io/client-go/kubernets.ClientSet</code>, which is a typed client. What that means is that this interface provides exclusive methods for each resource on Kubernetes (think of Pods, Deployments, Services, everything!) and operation (Create, Get, List, Watch, Update, Patch and Delete). It is obvious why you should, whenever possible, prefer to use this client.</p><p>However, there are situations where this can be limiting. It is when <code>k8s.io/client-go/dynamic.Interface</code>, the dynamic client, will enter the game. This client has a twofold purpose:</p><p>First, it allows working with custom resources while avoiding strong dependencies. If you want to build some automation or workflow using another Operator as the building block, like ExternalDNS, CertManager, or Prometheus (Operator) usually you would need to add these projects as dependencies to use their Go types and register them on your client instance. This obviously introduces a lot of burdens as you now need to manage their ever-evolving versions and try to keep the version you have installed on the cluster matching the version on your <code>go.mod</code>.</p><p>Secondly, you can work with multiple or unknown resources. When your operator implements a generic logic that can interact with any common Kubernetes resource (from RBAC to Pods) and even custom resources, the dynamic client may be your only solution. A few examples are the garbage collection controller relies heavily on it and if you would want to add support for an arbitrary custom resource on a project like <a href=https://github.com/bitnami-labs/kubewatch>KubeWatch</a>.</p><p>Therefore, let&rsquo;s dive into this resourceful (<em>pun intended</em>) component of the <a href=http://k8s.io/client-go><code>k8s.io/client-go</code></a> project and see how we can leverage it.</p><h2 id=basic-operations-with-the-dynamic-client>Basic operations with the dynamic client<a hidden class=anchor aria-hidden=true href=#basic-operations-with-the-dynamic-client>#</a></h2><blockquote><p>The code below assumes to be running inside a Kubernetes cluster.</p></blockquote><p>Many operations with the dynamic client is similar to the typed client, like creating a new instance can be done by providing the config to its constructor:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newClient</span><span class=p>()</span> <span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rest</span><span class=p>.</span><span class=nf>InClusterConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>dynClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>dynClient</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Since the dynamic client has no knowledge about the resource you want to consume, it does not provide helper methods like <code>CoreV1().Pod</code> . Instead, you need to first provide a <code>schema.GroupVersionResource</code>, which is a Golang type that provides the necessary information to construct an HTTP request to the cluster API Server.</p><p>For example, if you want a function to list all MongoDB resources from the MongoDB Community Operator:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>monboDBResource</span> <span class=p>=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=s>&#34;mongodbcommunity.mongodb.com&#34;</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span> <span class=nx>Resource</span><span class=p>:</span> <span class=s>&#34;mongodbcommunity&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ListMongoDB</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>client</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=nx>unstructured</span><span class=p>.</span><span class=nx>Unstructured</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// GET /apis/mongodbcommunity.mongodb.com/v1/namespaces/{namespace}/mongodbcommunity/
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>list</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>monboDBResource</span><span class=p>).</span><span class=nf>Namespace</span><span class=p>(</span><span class=nx>namespace</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>list</span><span class=p>.</span><span class=nx>Items</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Note that if you are dealing with a namespaced resource then <code>.Namespace(namespace)</code> is obligatory, even if you will use an empty string to list on all namespaces.</p><p>In this snippet, we can see the main companion of the dynamic client: <code>unstructured.Unstructured</code>. This is a special type that encapsulates an arbitrary JSON while also complying with standard Kubernetes interfaces like <code>runtime.Object</code> , but most importantly it provides a set of helpers on the <code>unstructured</code> package to manipulate this data.</p><p>Expanding our example, if we would scale a MongoDB by an proportion we could do so like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ScaleMongoDB changes the number of members by the given proportion,
</span></span></span><span class=line><span class=cl><span class=c1>// which should be 0 =&lt; proportion &lt; 1.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ScaleMongoDB</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>client</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>proportion</span> <span class=kt>uint</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>proportion</span> <span class=p>&gt;</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;proportion should be between 0 =&lt; proportion &lt; 1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>mongoDBClient</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>monboDBResource</span><span class=p>).</span><span class=nf>Namespace</span><span class=p>(</span><span class=nx>namespace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>mdb</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mongoDBClient</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GetOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>members</span><span class=p>,</span> <span class=nx>found</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>unstructured</span><span class=p>.</span><span class=nf>NestedInt64</span><span class=p>(</span><span class=nx>mdb</span><span class=p>.</span><span class=nf>UnstructuredContent</span><span class=p>(),</span> <span class=s>&#34;spec&#34;</span><span class=p>,</span> <span class=s>&#34;members&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>found</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;members field not found on MongoDB spec&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>scaled</span> <span class=o>:=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>members</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=nb>int</span><span class=p>(</span><span class=nx>proportion</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>patch</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>		<span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;op&#34;</span><span class=p>:</span>    <span class=s>&#34;replace&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;path&#34;</span><span class=p>:</span>  <span class=s>&#34;/spec/members&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;value&#34;</span><span class=p>:</span> <span class=nx>scaled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>payload</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>patch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>mongoDBClient</span><span class=p>.</span><span class=nf>Patch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nx>JSONPatchType</span><span class=p>,</span> <span class=nx>payload</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>PatchOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here we leverage <code>unstructured.NestedInt64</code> to access only the field that we are interested in, keeping our coupling to the MongoDB CRD to a minimum while also being able to manipulate the resource data with type safety.</p><p>The <code>unstructured</code> package has lots of helpers like this, not only for reading but also for writing to any field on the resource.</p><p>Performing all the usual operations on Kubernetes (get, list, watch, create, patch, and delete) follow the same approach: provide the <code>scheme.GroupVersionResource</code> and handle the <code>unstructured.Unstructured</code> result.</p><h2 id=controller-with-a-dynamic-client>Controller with a dynamic client<a hidden class=anchor aria-hidden=true href=#controller-with-a-dynamic-client>#</a></h2><p>More advanced but frequent use of a Kubernetes client is to build a controller that reacts to changes on the actual cluster state to bring it to the desired state.</p><p>Usually, we leverage an Informer, a component provided by <code>k8s.io/client-go</code>, that runs a handler when changes are detected, created from a typed client. Luckily the <code>dynamic</code> package also provides an Informer component that we can use.</p><p>For example, if we want to capture when a MongoDB is deleted to clean the associated <code>PersistentVolumeClaims</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>utilruntime</span> <span class=s>&#34;k8s.io/apimachinery/pkg/util/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/util/wait&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/dynamic&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/dynamic/dynamicinformer&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/util/workqueue&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>maxRetries</span> <span class=p>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>monboDBResource</span> <span class=p>=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=s>&#34;mongodbcommunity.mongodb.com&#34;</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span> <span class=nx>Resource</span><span class=p>:</span> <span class=s>&#34;mongodbcommunity&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>MongoDBController</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>informer</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>SharedIndexInformer</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopper</span>  <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>queue</span>    <span class=nx>workqueue</span><span class=p>.</span><span class=nx>RateLimitingInterface</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewMongoDBController</span><span class=p>(</span><span class=nx>client</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Interface</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>MongoDBController</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>dynInformer</span> <span class=o>:=</span> <span class=nx>dynamicinformer</span><span class=p>.</span><span class=nf>NewDynamicSharedInformerFactory</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>informer</span> <span class=o>:=</span> <span class=nx>dynInformer</span><span class=p>.</span><span class=nf>ForResource</span><span class=p>(</span><span class=nx>monboDBResource</span><span class=p>).</span><span class=nf>Informer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopper</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>queue</span> <span class=o>:=</span> <span class=nx>workqueue</span><span class=p>.</span><span class=nf>NewRateLimitingQueue</span><span class=p>(</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>DefaultControllerRateLimiter</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>informer</span><span class=p>.</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>key</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>DeletionHandlingMetaNamespaceKeyFunc</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>queue</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>MongoDBController</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>informer</span><span class=p>:</span> <span class=nx>informer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>queue</span><span class=p>:</span> <span class=nx>queue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>stopper</span><span class=p>:</span> <span class=nx>stopper</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MongoDBController</span><span class=p>)</span> <span class=nf>Stop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nb>close</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>stopper</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MongoDBController</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>m</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>ShutDown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>m</span><span class=p>.</span><span class=nx>informer</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>stopper</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// wait for the caches to synchronize before starting the worker
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>cache</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>stopper</span><span class=p>,</span> <span class=nx>m</span><span class=p>.</span><span class=nx>informer</span><span class=p>.</span><span class=nx>HasSynced</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;timed out waiting for caches to sync&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// runWorker will loop until some problem happens. The wait.Until will then restart the worker after one second
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>runWorker</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>m</span><span class=p>.</span><span class=nx>stopper</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MongoDBController</span><span class=p>)</span> <span class=nf>runWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>key</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>processItem</span><span class=p>(</span><span class=nx>key</span><span class=p>.(</span><span class=kt>string</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>m</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Forget</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>m</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>maxRetries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>m</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>m</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Forget</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>m</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>MongoDBController</span><span class=p>)</span> <span class=nf>processItem</span><span class=p>(</span><span class=nx>mongodb</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Clean up PVCs
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Most of this code is standard, like the work queue, informer event handlers, and item processing, of a controller using the typed client.</p><p>Hence, leveraging the decoupling provided by the dynamic client really comes with a low overhead in terms of complexity.</p><h2 id=testing-with-the-dynamic-client>Testing with the dynamic client<a hidden class=anchor aria-hidden=true href=#testing-with-the-dynamic-client>#</a></h2><p>If we were to scale the use of the dynamic client it is paramount that it is as easy to test as the typed client.</p><p>As in the controller case, the <code>dynamic</code> package provides an equivalent fake client that allows for stubbing objects and asserting actions performed using it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>dynamicfake</span> <span class=s>&#34;k8s.io/client-go/dynamic/fake&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestDynamicClient</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Setup an Object as mock on the client
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Write it like its YAML manifest
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mdb</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>unstructured</span><span class=p>.</span><span class=nx>Unstructured</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>mdb</span><span class=p>.</span><span class=nf>SetUnstructuredContent</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s>&#34;mongodbcommunity.mongodb.com/v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;kind&#34;</span><span class=p>:</span> <span class=s>&#34;MongoDBCommunity&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;metadata&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;name&#34;</span><span class=p>:</span>      <span class=s>&#34;mongodb-test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;namespace&#34;</span><span class=p>:</span> <span class=s>&#34;default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;spec&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;members&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>dynamicClient</span> <span class=o>:=</span> <span class=nx>dynamicfake</span><span class=p>.</span><span class=nf>NewSimpleDynamicClient</span><span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nf>NewScheme</span><span class=p>(),</span> <span class=nx>mdb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run any logic that depend on the dynamic client
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>NotifyMongoDBs</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>dynamicClient</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>AssertActions</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span>  <span class=nx>dynamicClient</span><span class=p>.</span><span class=nf>Actions</span><span class=p>(),</span> <span class=p>[]</span><span class=nx>ExpectedAction</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Verb</span><span class=p>:</span> <span class=s>&#34;list&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Namespace</span><span class=p>:</span> <span class=s>&#34;default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Resource</span><span class=p>:</span> <span class=s>&#34;mongodbcommunity&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Using the <code>unestructured.Unestructured</code> type we can create stub Kubernetes objects using the same syntax as in YAML, but with maps.</p><p>After performing the tested logic we can use <code>dynamicClient.Actions()</code> to see all operations that were performed by our code. However, manually asserting these actions on every test often lead to unreadable code and brittle assertions.</p><p>Hence, I often use a special assertion function <code>AssertActions</code> that verify if every expected action can be found in the performed actions. An important note is that this function does not perform an exact list match, i.e. if a delete operation was performed using the client the test would not break, the only condition for the <code>AssertActions</code> to fail is if the list operation provided on the expected list isn&rsquo;t found. One could change the asserting function or make a sibling function that validates only if the expected actions were performed.</p><p>Although the current implementation is verbose, this function has the benefit of working both with the dynamic and the typed client.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ExpectedAction</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Verb</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Namespace</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Resource</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Patch action
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>PatchType</span> <span class=nx>types</span><span class=p>.</span><span class=nx>PatchType</span>
</span></span><span class=line><span class=cl>	<span class=nx>PatchPayload</span> <span class=p>[]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AssertActions</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>,</span> <span class=nx>got</span> <span class=p>[]</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>Action</span><span class=p>,</span> <span class=nx>expected</span> <span class=p>[]</span><span class=nx>ExpectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>expected</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>got</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;executed actions too short, expected %d, got %d&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>expected</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=nx>got</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>expectedAction</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>expected</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nf>AssertExpectedAction</span><span class=p>(</span><span class=nx>got</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;action %d does not match any of the got actions&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AssertExpectedAction</span><span class=p>(</span><span class=nx>got</span> <span class=p>[]</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>Action</span><span class=p>,</span> <span class=nx>expectedAction</span> <span class=nx>ExpectedAction</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>gotAction</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>got</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>expectedAction</span><span class=p>.</span><span class=nx>Verb</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;get&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>getAction</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>gotAction</span><span class=p>.(</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>GetAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>getAction</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>expectedAction</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>getAction</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;list&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>listAction</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>gotAction</span><span class=p>.(</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>ListAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>listAction</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;watch&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>watchAction</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>gotAction</span><span class=p>.(</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>WatchAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>watchAction</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;create&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>createAction</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>gotAction</span><span class=p>.(</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>CreateAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>createAction</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;update&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>updateAction</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>gotAction</span><span class=p>.(</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>UpdateAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>updateAction</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;delete&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>deleteAction</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>gotAction</span><span class=p>.(</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>DeleteAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>deleteAction</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>expectedAction</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>deleteAction</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;patch&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>patchAction</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>gotAction</span><span class=p>.(</span><span class=nx>kubetesting</span><span class=p>.</span><span class=nx>PatchAction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>patchAction</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>expectedAction</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>patchAction</span><span class=p>,</span> <span class=nx>expectedAction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>patchAction</span><span class=p>.</span><span class=nf>GetPatchType</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>expectedAction</span><span class=p>.</span><span class=nx>PatchType</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>patchBytes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>expectedAction</span><span class=p>.</span><span class=nx>PatchPayload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>bytes</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>patchAction</span><span class=p>.</span><span class=nf>GetPatch</span><span class=p>(),</span> <span class=nx>patchBytes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>validateNamespaceAndResource</span><span class=p>(</span><span class=nx>action</span> <span class=nx>kubetesting</span><span class=p>.</span><span class=nx>Action</span><span class=p>,</span> <span class=nx>expectedAction</span> <span class=nx>ExpectedAction</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>action</span><span class=p>.</span><span class=nf>GetNamespace</span><span class=p>()</span> <span class=o>==</span> <span class=nx>expectedAction</span><span class=p>.</span><span class=nx>Namespace</span> <span class=o>&amp;&amp;</span> <span class=nx>action</span><span class=p>.</span><span class=nf>GetResource</span><span class=p>().</span><span class=nx>Resource</span> <span class=o>==</span> <span class=nx>expectedAction</span><span class=p>.</span><span class=nx>Resource</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This asserting function allows for more conditions to be added, like verifying list/watch restrictions and create/update bodies.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>The Kubernetes ecosystem is rich and every now and then we stumble upon this kind of treasure. I strongly recommend reading through the documentation not only of the <a href=http://k8s.io/client-go><code>k8s.io/client-go</code></a> project but also from the <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime><code>sigs.k8s.io/controller-runtime</code></a> project and the <a href=https://kubernetes.io/docs/reference/kubernetes-api/>Kubernetes Reference API</a> documentation.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://caioferreira.dev/tags/go/>go</a></li><li><a href=https://caioferreira.dev/tags/kubernetes/>kubernetes</a></li><li><a href=https://caioferreira.dev/tags/testing/>testing</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share The Kubernetes dynamic client on twitter" href="https://twitter.com/intent/tweet/?text=The%20Kubernetes%20dynamic%20client&amp;url=https%3a%2f%2fcaioferreira.dev%2fposts%2fthe-kubernetes-dynamic-client%2f&amp;hashtags=go%2ckubernetes%2ctesting"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share The Kubernetes dynamic client on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcaioferreira.dev%2fposts%2fthe-kubernetes-dynamic-client%2f&amp;title=The%20Kubernetes%20dynamic%20client&amp;summary=The%20Kubernetes%20dynamic%20client&amp;source=https%3a%2f%2fcaioferreira.dev%2fposts%2fthe-kubernetes-dynamic-client%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share The Kubernetes dynamic client on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcaioferreira.dev%2fposts%2fthe-kubernetes-dynamic-client%2f&title=The%20Kubernetes%20dynamic%20client"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://caioferreira.dev/>Simple Made Daily</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>